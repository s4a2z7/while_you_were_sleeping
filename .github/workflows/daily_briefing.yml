name: Daily Stock Briefing

on:
  schedule:
    # 매일 한국시간 아침 7시 (UTC 22:00)에 실행
    - cron: '0 22 * * *'
  
  # 수동 실행 가능
  workflow_dispatch:

jobs:
  daily-briefing:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1. 저장소 코드 확인
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Python 3.12 설정
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      # 3. 의존성 설치
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      # 4. 화제 종목 조회
      - name: Run Screener Service
        run: |
          cd backend
          python -m services.screener_service
        env:
          PYTHONUNBUFFERED: 1

      # 5. 브리핑 생성
      - name: Generate Briefing
        run: |
          cd backend
          python -m services.briefing_generator
        env:
          PYTHONUNBUFFERED: 1

      # 6. 이메일 발송
      - name: Send Email
        run: |
          cd backend
          python -m services.email_service
        env:
          PYTHONUNBUFFERED: 1
          # 환경 변수는 GitHub Secrets에서 로드
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
          EXA_API_KEY: ${{ secrets.EXA_API_KEY }}

      # 7. 인스타그램 발행
      - name: Post to Instagram
        run: |
          cd backend
          python -m services.instagram_service
        env:
          PYTHONUNBUFFERED: 1
          INSTAGRAM_USERNAME: ${{ secrets.INSTAGRAM_USERNAME }}
          INSTAGRAM_PASSWORD: ${{ secrets.INSTAGRAM_PASSWORD }}

      # 8. Threads 발행
      - name: Post to Threads
        run: |
          cd backend
          python -m services.threads_service
        env:
          PYTHONUNBUFFERED: 1
          INSTAGRAM_USERNAME: ${{ secrets.INSTAGRAM_USERNAME }}
          INSTAGRAM_PASSWORD: ${{ secrets.INSTAGRAM_PASSWORD }}

      # 7. 성공 알림
      - name: Notify Success
        if: success()
        run: |
          echo "✅ Daily briefing completed successfully"
          echo "Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      # 8. 실패 알림
      - name: Notify Failure
        if: failure()
        run: |
          echo "❌ Daily briefing failed"
          echo "Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        # 실패 시 선택적으로 Slack/Discord 알림 추가 가능
